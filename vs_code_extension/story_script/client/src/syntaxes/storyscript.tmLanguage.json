{
	"$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
	"name": "StoryScript",
	"scopeName": "source.storyscript",
	"patterns": [
		{
			"include": "#comment-line"
		},
		{
			"include": "#storyScript"
		}
	],
	
	"repository": {
		
		"storyScript": {
			"patterns": [
				{
					"include": "#code-line"
				}
			]
		},

		"comment-line": {
			"patterns": [
				{
					"name": "comment",
					"match": "//.*$"
				}
			]
		},

		"code-line": {
			"patterns": [
				{
					"include": "#comment-line"
				},
				{
					"include": "#item-line"
				},
				{
					"include": "#text-line"
				}
			]
		},

		"item-line": {
			"patterns": [
				{
					"match": "^\\s*(\\*)\\s(\\b\\w+\\b):(.*)?",
					"captures": {
						"1": {
							"name": "keyword"
						},
						"2": {
							"name": "support.type"
						},
						"3": {
							"patterns": [{
								"include": "#item-type"
							}]
						}
					}
				}
			]
		},
		
		"text-line": {
			"patterns": [
				{
					"match": "([^@]*)(.*)",
					"captures": {
						"1": {
							"name": "string"
						},
						"2": {
							"patterns": [
								{
									"include": "#mention-or-text-line"
								}
							]
						}
					}
				}
			]
		},

		"mention-or-text-line": {
			"patterns": [
				{
					"match": "(@[\\w\\.]+\\b)(.*)",
					"captures": {
						"1": {
							"name": "constant.character.escape"
						},
						"2": {
							"patterns": [
								{
									"include": "#text-line"
								}
							]
						}
					}
				}
			]
		},
		
		"item-type": {
			"patterns": [
				{
					"include": "#item-type-simple"
				},
				{
					"include": "#item-type-array"
				},
				{
					"include": "#item-type-function"
				},
				{
					"match": "//.*",
					"name": "comment.block"
				}
			]
		},
		"item-type-function": {
			"patterns": [
				{
					"match": "(\\b[\\w\\.]+\\b)\\((.*?)\\)(.*)",
					"captures": {
						"1": {
							"name": "support.type"
						},
						"2": {
							"patterns": [
								{
									"include": "#function-params"
								}
							]
						},
						"3": {
							"name": "comment.block"
						}
					}
				}
			]
		},
		"item-type-array": {
			"patterns": [
				{
					"match": "(\\b[\\w\\.]+\\b)\\[(\\d*)\\](.*)",
					"captures": {
						"1": {
							"name": "support.type"
						},
						"2": {
							"name": "constant.numeric"
						},
						"3": {
							"patterns": [
								{
									"include": "#item-type"
								}
							]
						}
					}
				}
			]
		},
		"item-type-simple": {
			"patterns": [
				{
					"match": "(\\b[\\w\\.]+\\b)([^\\(^\\[]*$)",
					"captures": {
						"1": {
							"name": "support.type"
						},
						"2": {
							"name": "comment.block"
						}
					}
				}
			]
		},

		"function-params": {
			"patterns": [
				{
					"match": "(\\b\\w+\\b)(.*)",
					"captures": {
						"1": {
							"name": "support.variable"
						},
						"2": {
							"patterns": [
								{
									"include": "#function-param-type"
								}
							]
						}
					}
				}
			]
		},
		"function-param-type": {
			"patterns": [
				{
					"match": "(: [\\w\\.\\[\\]]+)(.*)",
					"captures": {
						"1": {
							"patterns": [
								{
									"include": "#item-type"
								}
							]
						},
						"2": {
							"patterns": [
								{
									"include": "#function-params"
								}
							]
						}
					}
				},
				{
					"match": ", (.*)",
					"captures": {
						"1": {
							"patterns": [
								{
									"include": "#function-params"
								}
							]
						}
					}
				}
			]
		},

		"invalid": {
			"patterns": [
				{
					"name": "invalid.illegal",
					"match": ".+?(?=//)"
				}
			]
		},
		
		"array-brackets": {
			"patterns": [
				{
					"match": "(\\[)(\\d+)*?(\\])",
					"captures": {
						"1": {
							"name": "constant"
						},
						"2": {
							"patterns": [
								{
									"include": "#digit"
								}
							]
						},
						"3": {
							"name": "constant"
						}
					}
				}
			]
		},

		"keywords": {
			"patterns": [
				{
					"name": "keyword",
					"match": "\\b(true|false|функция)\\b"
				}
			]
		},

		"comment-or-invalid": {
			"patterns": [
				{
					"include": "#comment-line"
				},
				{
					"include": "#invalid"
				}
			]
		},


		"digit": {
			"patterns": [
				{
					"name": "constant.numeric",
					"match": "\\d+"
				}
			]
		}

	}

}